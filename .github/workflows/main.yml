name: CI/CD Pipeline for Wisecow

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      - name: Build and Push Docker Image
        run: |
          docker build -t pratikmaghade/wisecow:latest .
          docker push pratikmaghade/wisecow:latest

  set-up-k8s-config:
    name: Set up Kubernetes Config
    runs-on: ubuntu-latest
    steps:
      - name: Create Kubernetes Config Directory
        run: mkdir -p $HOME/.kube

      - name: Decode and Set Kubeconfig
        run: echo "${{ secrets.KUBECONFIG }}" | base64 --decode > $HOME/.kube/config

      - name: Validate Kubernetes Context
        run: kubectl config current-context

  deploy-to-cluster:
    name: Deploy to Kubernetes Cluster
    runs-on: ubuntu-latest
    needs: [build-and-push, set-up-k8s-config]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Apply Kubernetes Manifests
        run: |
          kubectl apply -f /home/ubuntu/wisecow/Deployment.yml
          kubectl apply -f /home/ubuntu/wisecow/Service.yml
          kubectl apply -f /home/ubuntu/wisecow/ingress.yml

      - name: Rollout Restart Deployment
        run: kubectl rollout restart deployment/wisecow-deployment

  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: deploy-to-cluster
    steps:
      - name: Check Deployment Status
        run: kubectl rollout status deployment/wisecow-deployment

      - name: Get All Services
        run: kubectl get services

      - name: Get Ingress
        run: kubectl get ingress

  legacy-support:
    name: Legacy Support Validation
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Kubernetes Config
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_LEGACY }}" | base64 --decode > $HOME/.kube/config

      - name: Validate Cluster on Legacy Setup
        run: kubectl get nodes
